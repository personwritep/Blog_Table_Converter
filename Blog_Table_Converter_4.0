// ==UserScript==
// @name          Blog Table â­ Converter
// @namespace    http://tampermonkey.net/
// @version       4.0
// @description  ç·¨é›†ç”»é¢ä¸Šã®tableè¡¨ã®è¡¨ä»•æ§˜å¤‰æ›ãƒ„ãƒ¼ãƒ«
// @author        Ameba Blog User
// @match        https://blog.ameba.jp/ucs/entry/srventry*
// @exclude      https://blog.ameba.jp/ucs/entry/srventrylist.do*
// @grant         none
// ==/UserScript==


let retry=0;
let interval=setInterval(wait_target, 100);
function wait_target(){
    retry++;
    if(retry>10){ // ãƒªãƒˆãƒ©ã‚¤åˆ¶é™ 10å› 1sec
        clearInterval(interval); }
    let target=document.getElementById('cke_1_contents'); // ç›£è¦– target
    if(target){
        clearInterval(interval);
        main(); }}



function main(){
    let ua=0; // Chromeã®å ´åˆã®ãƒ•ãƒ©ã‚°
    let agent=window.navigator.userAgent.toLowerCase();
    if(agent.indexOf('firefox') > -1){ ua=1; } // Firefoxã®å ´åˆã®ãƒ•ãƒ©ã‚°

    let task=0; // èµ·å‹•1ãƒ»ä½œæˆ2ãƒ»æ›´æ–°3ãƒ»çµ‚äº†0
    let trim=0; // è¿½åŠ 0ãƒ»å‰Šé™¤1
    let cell_set=0; // ã‚»ãƒ«å¹…è¨­å®šãƒ‘ãƒãƒ«ã®åˆ—é¸æŠ

    let posit_set; // ä¸­å¤®å¯„ã›ãƒ»å·¦å¯„ã›
    let table_position;
    let border_collapse;
    let add_padd; // td ã®paddingå€¤
    let layout_fix; // table-layoutè¨­å®š
    let table_border_width;
    let cell_border_width;
    let border_space;
    let left_full; // å·¦ç«¯èƒŒæ™¯è‰²ã®å„ªå…ˆ
    let color_input=[]; // 4å€‹ã®ã‚«ãƒ©ãƒ¼è¨­å®šæ 
    let word_break; // è‹±æ–‡ç¦å‰‡


    let target=document.getElementById('cke_1_contents'); // ç›£è¦– target
    let monitor=new MutationObserver( catch_key );
    monitor.observe(target, {childList: true, attributes: true}); // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå¾…å—ã‘é–‹å§‹

    catch_key();

    function catch_key(){
        if(document.querySelector('.cke_wysiwyg_frame') !=null){ //ã€Œé€šå¸¸è¡¨ç¤ºã€ã‹ã‚‰å®Ÿè¡Œé–‹å§‹
            let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            let iframe_doc=editor_iframe.contentWindow.document;

            iframe_doc.addEventListener('keydown', check_key);
            document.addEventListener('keydown', check_key);

            function check_key(event){
                if(event.keyCode==13 && iframe_doc.hasFocus()){
                    remove_mark(); } // æ”¹è¡Œå…¥åŠ›ãŒé€£ç¶šãƒãƒ¼ã‚¯ã¨ãªã‚‹ã®ã‚’æŠ‘æ­¢

                let gate=-1;
                if(event.ctrlKey==true){
                    if(event.keyCode==112){
                        event.preventDefault(); gate=1; }
                    if(gate==1){
                        event.stopImmediatePropagation();
                        do_task(); }}}

            function do_task(){
                if(task==0){
                    caution();
                    task=1;
                    table_panel();
                    enhanced(); }
                else{
                    task=0;
                    remove_t_panel();
                    remove_mark_all(); }}}

        before_end();

    } // catch_key()



    function caution(){
        let disp=
            '<div class="caution_disp">'+
            '<span>'+
            'ã€ŒBlog Table â­ã€ver.4.0 ä»¥å‰ã§ä½œæˆã—ãŸè¡¨ã‚’è»½é‡åŒ–ã—ã¾ã™ã€‚<br>'+
            'è¡¨ã®ã‚¹ã‚¿ã‚¤ãƒ«æŒ‡å®šã®ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã‚’ styleã‚¿ã‚°ã«çºã‚ã‚‹å‡¦ç†ã§ã€<br>'+
            'è¡¨ãƒ‡ãƒ¼ã‚¿ã‚’å¤±ã†äº‹ã¯é€šå¸¸ã¯ç”Ÿã˜ã¾ã›ã‚“ãŒã€HTMLç·¨é›†ã«ã‚ˆã£ã¦<br>'+
            'ãƒ‡ã‚¶ã‚¤ãƒ³ã—ãŸè¡¨ã¯ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã®å´©ã‚Œã‚’ç”Ÿã˜ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>'+
            'ãã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã®å¤šã„è¡¨ãƒ»è²´é‡ãªè¡¨ã‚’å«ã‚€è¨˜äº‹ã¯ã€è¨˜äº‹ã‚’<br>'+
            'è¤‡è£½ã—ãŸä¸Šã§ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹äº‹ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚<br><br>'+
            'ã¾ãŸã€è»½é‡åŒ–ã‚’ã—ãŸè¡¨ã¯ã€ŒBlog Table â­ã€ver.4.0 ä»¥é™ã§ãª <br>'+
            'ãªã„ã¨è¡¨ã®æ›´æ–°ãŒã§ããªããªã‚Šã¾ã™ã€‚<br>'+
            '</span>'+
            '<input type="button" class="x" value="âœ–">'+
            '<style>'+
            '.caution_disp { position: absolute; top: 120px; left: calc( 50% - 425px); '+
            'width: 520px; height: auto; font: 18px Meiryo; background: #fff; '+
            'padding: 40px; border: 2px solid #aaa; z-index: 20; }'+
            '.x { position: absolute; top: 8px; right: 9px; padding: 2px 7px 0; }'+
            '</style></div>';

        if(!document.querySelector('.caution_disp')){
            document.body.insertAdjacentHTML('beforeend', disp); }

        let caution_disp=document.querySelector('.caution_disp');
        let x=document.querySelector('.caution_disp .x');
        if(x){
            x.onclick=(()=>{ caution_disp.remove(); }); }}



    function table_panel(){

        let panel=
            '<div id="t_panel">'+
            '<span class="t_label">æ§‹æˆ</span>'+
            '<div class="wnc"><input id="col" type="number" min="1"></div>'+
            '<div class="wnr"><input id="row" type="number" min="1"></div>'+
            '<span class="t_label">é…ç½®</span>'+
            '<input id="wide" type="submit" value="ã€€">'+
            '<span class="t_label">è¡¨å¹…</span>'+
            '<div class="wpxt"><input id="t_width" type="number" min="10" max="1000"></div>'+
            '<input id="t_width_m" type="submit" value="Ğ¼">'+
            '<input id="td_padd" type="submit" value="ã€€">'+
            '<input id="equal" type="submit" value="ã€€">'+
            '<span class="t_label">æ ç·š</span>'+
            '<div class="wpx"><input id="border_width" type="number" min="-9"></div>'+
            '<input id="border_color" type="text" autocomplete="off">'+
            '<span class="t_label">æœ€ä¸Šè¡ŒèƒŒæ™¯</span>'+
            '<input id="header_back" type="text" autocomplete="off">'+
            '<span class="t_label">å·¦ç«¯åˆ—èƒŒæ™¯</span>'+
            '<input id="left_back" type="text" autocomplete="off">'+
            '<input id="left_back_f" type="submit" value="â–²">'+
            '<span class="t_label">å…¨ä½“èƒŒæ™¯</span>'+
            '<input id="cell_back" type="text" autocomplete="off">'+
            '<span class="t_label">æ–‡å­—</span>'+
            '<div class="wpx"><input id="t_font" type="number" min="12" max="32"></div>'+
            '<input id="set" type="submit" value="ã€€">'+
            '<span id="test"></span>'+

            '<div id="first">'+
            '<span id="bt_help">ï¼Ÿ</span>'+
            '<div class="bt_help1">'+
            'è»½é‡ã‚¿ã‚¤ãƒ—ã«å¤‰æ›´ã™ã‚‹è¡¨ã‚’<b>ã€ŒCtrl+å·¦Clickã€</b>ã§æŒ‡å®šã—ã¾ã™ã€€ã€€'+
            '<b>ã€Œè»½é‡åŒ–ã€</b>ä»¥å¤–ã®ãƒœã‚¿ãƒ³ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“</div>'+
            '</div>'+

            '<style>'+
            '#t_panel { position: fixed; top: 15px; left: calc(50% - 490px); width: 954px; '+
            'font-size: 14px; padding: 6px 12px; overflow: hidden; '+
            'border: 1px solid #ccc; border-radius: 4px; background: #eff5f6; z-index: 10; }'+
            '#t_panel * { user-select: none; }'+
            '#t_panel input { position: relative; margin-right: 10px; padding-top: 2px; '+
            'height: 27px; box-sizing: border-box; border: thin solid #aaa; }'+
            '#t_panel input[type="number"] { padding-right: 2px; margin-right: 0; }'+
            '#t_panel input[type="number"]:focus, #t_panel input[type="submit"]:focus '+
            '{ box-shadow: none; }'+
            '.t_label { margin: 0 3px 0 0; }'+

            '#col, #row { width: 40px; text-align: center; }'+
            '#wide { width: 30px; letter-spacing: -0.5em; text-indent: -6px; }'+
            '#t_width { width: 54px; text-align: center; }'+
            '#t_width_m { margin-left: -9px; width: 14px; }'+
            '#td_padd { width: 30px; margin-left: 2px; }'+
            '#equal { width: 34px; }'+
            '#border_width { width: 40px; text-align: center; }'+
            '#left_back_f { margin-left: -9px; width: 14px; text-indent: -1px; }'+
            '#t_font { width: 40px; text-align: center; }'+
            '#wide, #t_width_m, #td_padd, #equal, #left_back_f { background: #fff; }'+

            '.wnc, .wnr, .wpx, .wpxt { position: relative; display: inline-block; }'+
            '.wnc { margin-right: 2px; }'+
            '.wnr, .wpx, .wpxt { margin-right: 10px; }'+
            '.wnc::after { content: "åˆ—"; }'+
            '.wnr::after { content: "è¡Œ"; }'+
            '.wpx::after, .wpxt::after { content: "px"; }'+
            '.wnc::after, .wnr::after, .wpx::after, .wpxt::after { position: absolute; right: 2px; '+
            'top: 2px; padding: 3px 0 0; width: 17px; background: #fff; }'+
            '.wpx:hover::after, .wpxt:hover::after, .wnc:hover::after, .wnr:hover::after '+
            '{ content: ""; }'+
            '.wpxt.lock { pointer-events: none; background: #80deea; }'+
            '.wpxt.lock::after { background: inherit; }'+
            '.wpxt.lock #t_width { background: inherit; }'+
            '#t_width_m.lock { pointer-events: none; background: #80deea !important; }'+

            '#border_color { margin-left: -9px; }'+
            '#border_color, #header_back, #left_back, #cell_back { '+
            'width: 0; padding: 2px 16px 0 0; cursor: pointer; }'+
            '#border_color:focus, #header_back:focus, #left_back:focus, #cell_back:focus { '+
            'width: 99px; margin-right: -71px; padding: 2px 0 0 22px; z-index: 1; cursor: text; }'+

            '#set { margin: 0 !important; padding: 2px 12px 0; float: right; font-size: 16px; }'+
            '#set:hover { background: #fff; color: #000; }'+
            '#set { background: #e01919; color: #fff; }'+

            '#first { position: absolute; top: 0; left: 0; color: #fff; background: #2196f3; '+
            'width: 100%; padding: 10px 0; font-size: 16px; text-align: center; }'+
            '#bt_help { position: absolute; top: 11px; right: 25px; padding: 2px 1px 0; '+
            'line-height: 16px; font-weight: bold; border-radius: 30px; '+
            'color: #2196f3; background: #fff; cursor: pointer; }'+
            '.bt_help1 { text-align: left; margin-left: 60px; }'+

            '#test { display: none; }'+
            '#cke_42 { top: 60px !important; left: calc( 50% - 45px) !important; }';

        if(ua==1){
            panel +=
                '.wpx::after, .wpxt::after { padding: 3px 1px 0; }'+
                '.wnc::after { padding: 3px 1px 0; }'+
                '.wnr::after { padding: 3px 1px 0; }'; }

        panel +=
            '</style>'+
            '</div>';

        if(!document.querySelector('#t_panel')){
            document.body.insertAdjacentHTML('beforeend', panel); }

    } // table_panel()



    function enhanced(){
        let target_r=document.getElementById('cke_1_contents'); // ç›£è¦– target
        let monitor_r=new MutationObserver(select);
        monitor_r.observe(target_r, {childList: true}); // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå¾…å—ã‘é–‹å§‹

        select();

        function select(){
            if(document.querySelector('.cke_wysiwyg_frame') !=null){ //ã€Œé€šå¸¸è¡¨ç¤ºã€ã‹ã‚‰å®Ÿè¡Œé–‹å§‹
                remove_mark_all(); // Htmlç·¨é›†å¾Œã®ãƒªã‚»ãƒƒãƒˆ
                show_first(1);
                let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
                let iframe_doc=editor_iframe.contentWindow.document;
                if(iframe_doc){
                    let style_if=
                        '<style id="style_if">'+
                        '.amb_active { box-shadow: #fff -4px 0px, red -8px 0px !important; }'+
                        '</style>';

                    if(!iframe_doc.head.querySelector('#style_if')){
                        iframe_doc.head.insertAdjacentHTML('beforeend', style_if); }

                    let editor=iframe_doc.querySelector('.cke_editable');
                    if(editor){
                        editor.onclick=function(event){
                            event.stopImmediatePropagation();

                            if(event.ctrlKey){
                                remove_mark_all();
                                if(task==1 || task==2 || task==3 || task==4){
                                    let elm=iframe_doc.elementFromPoint(event.clientX, event.clientY);
                                    if(elm.closest('table')!=null){
                                        let table_id=elm.closest('table').id;
                                        if(table_id && table_id.includes('ambt')){
                                            let style_tag=elm.closest('table').previousElementSibling;
                                            if(style_tag && style_tag.classList.contains(table_id)){
                                                remove_mark();
                                                show_first(1);
                                                setTimeout(()=>{
                                                    alert(" â›” é¸æŠã—ãŸè¡¨ã¯ è»½é‡ã‚¿ã‚¤ãƒ—ã®è¡¨ã§ å‡¦ç†ã®å¯¾è±¡ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
                                                },20 ); }
                                            else{
                                                elm.closest('table').parentNode.classList.add('amb_active');
                                                show_first(0);
                                                task=3;
                                                check_available(elm.closest('table'));
                                                edit_table(task, elm.closest('table')); }}}}}} //ã€Œè¡¨æ›´æ–°ã€

                    }}}} // select()

    } // enhanced()



    function table_position_set(){
        let wide=document.querySelector('#wide'); // ä¸­å¤®é…ç½®ãƒ»å·¦å¯„ã›ã®è¨­å®š
        if(posit_set==0){
            wide.value='ã€€â–¢ã€€';
            table_position='0 auto'; }
        else if(posit_set==1){
            wide.value='â–¢ã€€ã€€';
            table_position='0 auto 0 0'; }}



    function t_width_lock(r_table){
        let count=0;
        let top_td=r_table.querySelectorAll('tr:first-child td');
        for(let k=0; k<top_td.length; k++){
            if(top_td[k].style.width){
                count+=1; }}
        if(count>0){
            table_lock(1); }
        else{
            table_lock(0); }}


    function table_lock(n){
        let wpxt=document.querySelector('.wpxt'); // è¡¨å¹…
        let t_width_m=document.querySelector('#t_width_m'); // MEMO
        if(n==0){
            wpxt.classList.remove('lock');
            t_width_m.classList.remove('lock'); }
        else{
            wpxt.classList.add('lock');
            t_width_m.classList.add('lock'); }}



    function td_padding_set(){
        let td_padd=document.querySelector('#td_padd'); // tdã®æ¨ªpadding æœ‰ç„¡ã®è¨­å®š
        if(add_padd=='0'){
            td_padd.value='p0';
            td_padd.style.boxShadow='none'; }
        else{
            td_padd.value='p+';
            td_padd.style.boxShadow='inset 6px 0 0 #cefed0, inset -6px 0 0 #cefed0'; }}



    function lafix_set(task, r_table){
        let equal=document.querySelector('#equal'); // table-layout ã®è¨­å®š
        if(layout_fix=='fixed'){
            equal.value='Fix';
            equal.style.background='#80deea'; }
        else{
            layout_fix='auto';
            equal.value='Auto';
            equal.style.background='#fff'; }}



    function table_border_set(){
        let border_width=document.querySelector('#border_width'); // æ ç·šå¹…ã®è¨­å®š
        two_way();

        function two_way(){
            if(border_width.value>-1){
                border_collapse='collapse';
                table_border_width=0;
                cell_border_width=border_width.value;
                border_space=0; }
            else if(border_width.value<0){
                border_collapse='separate';
                table_border_width=1;
                cell_border_width=1;
                border_space=border_width.value*(-1); }}}



    function left_full_set(){
        let left_back_full=document.querySelector('#left_back_f'); // å·¦ç«¯è‰²ã‚’æœ€ä¸Šè¡Œã¾ã§è¨­å®š
        if(left_full==' tr:not(:first-child)'){
            left_back_full.style.color='#aaa';
            left_back_full.style.boxShadow='none'; }
        else{
            left_back_full.style.color='red';
            left_back_full.style.boxShadow='inset 0 5px red'; }}



    function sticky_color(box){
        box.style.boxShadow='inset 17px 0 '+ box.value +', inset 18px 0 #aaa'; }



    function edit_table(task, r_table){
        let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
        let iframe_doc=editor_iframe.contentWindow.document;

        let this_col; // æ›´æ–°å‰ã®åˆ—æ•°
        let this_row; // æ›´æ–°å‰ã®è¡Œæ•°
        let col=document.querySelector('#col'); // åˆ—æ•°ã®è¨­å®š
        let row=document.querySelector('#row'); // è¡Œæ•°ã®è¨­å®š
        let wide=document.querySelector('#wide'); // é…ç½®
        let t_width=document.querySelector('#t_width'); // è¡¨å…¨å¹…ã®è¨­å®š
        let t_width_m=document.querySelector('#t_width_m'); // Memo
        let td_padd=document.querySelector('#td_padd'); // Padd
        let equal=document.querySelector('#equal'); // Fix
        let border_width=document.querySelector('#border_width'); // æ ç·šå¹…ã®è¨­å®š
        let border_color=document.querySelector('#border_color'); // æ ç·šè‰²ã®è¨­å®š
        let header_back=document.querySelector('#header_back'); // æœ€ä¸Šè¡ŒèƒŒæ™¯è‰²ã®è¨­å®š
        let left_back=document.querySelector('#left_back'); // å·¦ç«¯è¡ŒèƒŒæ™¯è‰²ã®è¨­å®š
        let left_back_f=document.querySelector('#left_back_f');
        let cell_back=document.querySelector('#cell_back'); // å…¨ä½“èƒŒæ™¯è‰²ã®è¨­å®š
        let t_font=document.querySelector('#t_font'); // æ–‡å­—ã‚µã‚¤ã‚ºã®è¨­å®š
        let set=document.querySelector('#set'); // ä½œæˆãƒœã‚¿ãƒ³

        col.disabled=true;
        row.disabled=true;
        wide.disabled=true;
        t_width.disabled=true;
        t_width_m.disabled=true;
        td_padd.disabled=true;
        equal.disabled=true;
        border_width.disabled=true;
        border_color.disabled=true;
        header_back.disabled=true;
        left_back.disabled=true;
        left_back_f.disabled=true;
        cell_back.disabled=true;
        t_font.disabled=true;

        if(task==3){
            set.value='è»½é‡åŒ–';
            table_renew(r_table); }


        function table_renew(r_table){
            t_width_lock(r_table);

            let t_tr=r_table.querySelectorAll('tr');
            row.value=t_tr.length;

            let t_td=r_table.querySelectorAll('td');
            col.value=t_td.length / t_tr.length;

            let margin_g=r_table.style.margin;
            if(margin_g && margin_g.includes('0px auto 0px 0px')){
                posit_set=1; }
            else {
                posit_set=0; }
            table_position_set();

            let t_width_g=r_table.style.width;
            if(t_width_g){
                t_width.value=t_width_g.replace(/[^0-9]/g, ''); }
            else{
                t_width.value=580; }

            let add_padd_g=t_td[t_td.length-1].style.paddingLeft;
            if(add_padd_g){
                add_padd=add_padd_g.slice(0, -2); } // è¡¨æœ«å°¾ã®ã€Œtdã€ã® padding
            else{
                add_padd=0; }
            td_padding_set();

            if(r_table.style.tableLayout=='fixed'){
                layout_fix='fixed'; }
            else{
                layout_fix='auto'; }
            lafix_set(3, r_table);

            let t_border_width_g=t_td[t_td.length-1].style.borderWidth;
            let t_border_width;
            if(t_border_width_g){
                t_border_width=t_border_width_g.replace(/[^0-9]/g, ''); } // è¡¨æœ«å°¾ã®ã€Œtdã€ã® border
            else{
                t_border_width=1; }
            let border_space_g=r_table.style.borderSpacing;
            if(border_space_g){
                border_space=border_space_g.replace(/[^0-9]/g, ''); }
            else{
                border_space=0; }
            if(border_space!=0){
                border_width.value=border_space*(-1); }
            if(border_space==0){
                border_width.value=t_border_width; }
            table_border_set();

            if(t_td[0].style.backgroundColor==''){ // è¡¨å…ˆé ­ã€Œtdã€ã®èƒŒæ™¯è‰²æŒ‡å®šã®æœ‰ç„¡
                left_full=' tr:not(:first-child)'; }
            else{
                left_full=' tr'; }
            left_full_set();

            let t_border_color=t_td[t_td.length-1].style.borderColor; // è¡¨æœ«å°¾ã®ã€Œtdã€ã® borderè‰²
            if(t_border_color==''){
                t_border_color='#999'; }
            border_color.value=rgb_hex(t_border_color);
            sticky_color(border_color);

            let t_header_back=t_tr[0].style.backgroundColor; // æœ€åˆã®ã€Œtrã€ã®èƒŒæ™¯è‰²
            if(t_header_back==''){
                t_header_back='#F4F4F4'; }
            header_back.value=rgb_hex(t_header_back);
            sticky_color(header_back);

            let t_left_back;
            if(t_tr.length>1){
                t_left_back=t_td[t_td.length / t_tr.length].style.backgroundColor; // å·¦ç«¯åˆ— èƒŒæ™¯è‰² 1
                if(t_left_back==''){
                    t_left_back='#F4F4F4'; }}
            else{
                t_left_back=t_td[0].style.backgroundColor; // å·¦ç«¯åˆ— èƒŒæ™¯è‰² 2
                if(t_left_back==''){
                    t_left_back='#F4F4F4'; }}
            left_back.value=rgb_hex(t_left_back);
            sticky_color(left_back);

            let t_cell_back=r_table.style.backgroundColor; // è¡¨ã€Œr_tableã€ã® èƒŒæ™¯è‰²
            if(t_cell_back==''){
                t_cell_back='#FFF';}
            cell_back.value=rgb_hex(t_cell_back);
            sticky_color(cell_back);

            let t_font_size=r_table.style.fontSize;
            if(t_font_size==''){
                t_font.value='16'; }
            else{
                t_font.value=t_font_size.replace(/[^0-9]/g, ''); }

            let t_word_break=r_table.style.wordBreak;
            if(t_word_break==''){
                word_break='unset'; }
            else{
                word_break=t_word_break; }



            set.onclick=function(){
                if(task==3){
                    let t_tr=r_table.querySelectorAll('tr');
                    this_row=t_tr.length;
                    let t_td=r_table.querySelectorAll('td');
                    this_col=t_td.length / t_tr.length;


                    renew_style(r_table);

                    r_table.removeAttribute('style');
                    let first_tr=r_table.querySelectorAll('tr')[0];
                    if(first_tr){
                        first_tr.removeAttribute('style'); }
                    let top_td=r_table.querySelectorAll('tr:first-child td');
                    top_td[0].style.backgroundColor=''; // ã‚³ãƒ¼ãƒŠãƒ¼ã®ã€Œtdã€ã®èƒŒæ™¯ã‚’ãƒªã‚»ãƒƒãƒˆ
                    for(let k=0; k<top_td.length; k++){
                        top_td[k].style.border='';
                        top_td[k].style.padding='';
                        top_td[k].style.height=''; }
                    let low_td=r_table.querySelectorAll('tr:not(:first-child) td');
                    for(let k=0; k<low_td.length; k++){
                        low_td[k].removeAttribute('style'); }



                    if(layout_fix=='fixed'){ //ã€ŒFixã€ãƒ¢ãƒ¼ãƒ‰æ™‚ã®tableå¹…é©æ­£åŒ–
                        let wpxt=document.querySelector('.wpxt'); // è¡¨å¹…
                        if(!wpxt.classList.contains('lock')){ //ã€ŒFixã€ãƒ¢ãƒ¼ãƒ‰ã§å¹…å¯å¤‰
                            let top_td=r_table.querySelectorAll('tr:first-child td');
                            for(let k=0; k<top_td.length; k++){
                                let set_w=getComputedStyle(top_td[k]).width;
                                if(set_w && !top_td[k].style.width){
                                    top_td[k].style.width=set_w; }}}

                        t_width_lock(r_table);

                        t_width.value='';
                        renew_style(r_table);
                        let t_width_g=getComputedStyle(r_table).width;
                        if(t_width_g){
                            t_width.value=Math.ceil((t_width_g.replace('px', ''))); } // åˆ‡ã‚Šä¸Šã’
                        else{
                            t_width.value=580; }
                        renew_style(r_table); }



                    setTimeout(()=>{
                        check_available(r_table);
                        alert(" ğŸŸ¢ è»½é‡åŒ–ã¸ã®å¤‰æ›å‡¦ç†ã‚’è¡Œã„ã¾ã—ãŸ");
                    }, 1000);

                }} // set.onclick()

        } // table_renew()

    } // edit_table()



    function renew_style(r_table){
        let table_id=r_table.id;
        let table_style=r_table.parentElement.querySelector('.'+ table_id);
        if(table_style){
            table_style.textContent=set_css(table_id); }
        else{
            let t_style='<style class="'+ table_id +'">'+ set_css(table_id) +'</style>';
            r_table.insertAdjacentHTML('beforeBegin', t_style); }}


    function set_css(t_id){
        let t_width=document.querySelector('#t_width'); // è¡¨å…¨å¹…ã®è¨­å®š
        let border_color=document.querySelector('#border_color'); // æ ç·šè‰²ã®è¨­å®š
        let header_back=document.querySelector('#header_back'); // æœ€ä¸Šè¡ŒèƒŒæ™¯è‰²ã®è¨­å®š
        let left_back=document.querySelector('#left_back'); // å·¦ç«¯è¡ŒèƒŒæ™¯è‰²ã®è¨­å®š
        let cell_back=document.querySelector('#cell_back'); // å…¨ä½“èƒŒæ™¯è‰²ã®è¨­å®š
        let t_font=document.querySelector('#t_font'); // æ–‡å­—ã‚µã‚¤ã‚ºã®è¨­å®š

        return '#'+ t_id + ' { '+
            'width: '+ t_width.value +'px; '+
            'margin: '+ table_position +'; '+
            'table-layout: '+ layout_fix +'; '+
            'border-collapse: '+ border_collapse +'; '+
            'border-spacing: '+ border_space +'px; '+
            'border: '+ table_border_width +'px solid '+ border_color.value +'; '+
            'font: '+ t_font.value +'px Meiryo; '+
            'background-color: '+ cell_back.value +'; '+
            'word-break: '+ word_break +'; } '+
            '#'+ t_id +' tr:first-child { background-color: '+ header_back.value +'; } '+
            '#'+ t_id + left_full +' td:first-child { background-color: '+ left_back.value +'; } '+
            '#'+ t_id +' td { border: '+ cell_border_width +'px solid '+ border_color.value +
            '; padding: 0.2em '+ add_padd +'em 0; height: 1.5em; }'; }



    function remove_t_panel(){
        document.querySelector('#t_panel').remove(); }



    function remove_mark(){
        if(document.querySelector('.cke_wysiwyg_frame') !=null){ //ã€Œé€šå¸¸è¡¨ç¤ºã€ã‹ã‚‰å®Ÿè¡Œé–‹å§‹
            let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            let iframe_doc=editor_iframe.contentWindow.document;

            let active_item=iframe_doc.querySelectorAll('.amb_active');
            for(let k=0; k<active_item.length; k++){
                active_item[k].classList.remove('amb_active'); }}}



    function remove_mark_all(){
        remove_mark(); }



    function show_first(n){
        let first=document.querySelector('#first');
        let bt_help1=document.querySelector('.bt_help1');
        if(first){
            if(n==0){
                first.style.display='none'; }
            else{
                first.style.display='block';
                bt_help1.style.display='none';
                if(n==1){
                    bt_help1.style.display='block'; }}}

        let bt_help=document.querySelector('#bt_help');
        if(bt_help){
            bt_help.onclick=function(){
                let url='https://ameblo.jp/personwritep/entry-12838591802.html';
                window.open(url, target="_blank"); }}}



    function check_available(test_table){
        let table_id=test_table.id;
        if(table_id && table_id.includes('ambt')){
            let set=document.querySelector('#set'); // ä½œæˆãƒœã‚¿ãƒ³
            let style_tag=test_table.previousElementSibling;
            if(style_tag && style_tag.classList.contains(table_id)){
                set.style.visibility='hidden'; }
            else{
                set.style.visibility=''; }}}



    function equal_color(R, G, B, A){ // RGBã¯æ•´æ•° Aã¯å°æ•°ãŒå¿…é ˆ â” ç­‰ä¾¡ 6æ¡hexã‚³ãƒ¼ãƒ‰ã«å¤‰æ›
        return '#'
            + tohex(upColor(R, A))
            + tohex(upColor(G, A))
            + tohex(upColor(B, A));

        function upColor(value, A){
            let color_value=value*A + 255*(1 - A);
            return Math.floor(color_value); }

        function tohex(value){
            return ('0'+ value.toString(16)).slice(-2); }}



    function hex_bright(hex){ // æ˜åº¦ã‚’æ®µéšçš„ã«å¤‰æ›
        if(hex.slice(0, 1)=='#'){
            hex=hex.slice(1); }
        if(hex.length==3){
            hex=hex.slice(0,1) + hex.slice(0,1) + hex.slice(1,2) + hex.slice(1,2) +
                hex.slice(2,3) + hex.slice(2,3); }
        // é€éåº¦ 0.6 ã¨ã—ãŸè‰²å€¤ã«å¤‰æ›´
        let R=parseInt(hex.slice(0, 2), 16);
        let G=parseInt(hex.slice(2, 4), 16);
        let B=parseInt(hex.slice(4, 6), 16);

        return equal_color(R, G, B, 0.6); } // éé€éè‰²å€¤ã«å¤‰æ›´



    function hex_8_6(hex){ // 8æ¡hexå€¤ã‚’6æ¡hexã«å¤‰æ›
        if(hex.length!=9 || hex.slice(0, 1)!='#'){
            return hex; }
        else{
            hex=hex.slice(1);

            let R=parseInt(hex.slice(0, 2), 16);
            let G=parseInt(hex.slice(2, 4), 16);
            let B=parseInt(hex.slice(4, 6), 16);
            let A=hex.slice(6, 8);
            // 16é€²ã®ã€ŒAå€¤ã€ã‚’é€éåº¦ï¼ˆå°æ•°ï¼‰ã«å¤‰æ›´
            let alp=0;
            for(let i=0; i<2; i++){
                alp +=Math.pow(16, -(i + 1))*parseInt(A[i], 16); }

            return equal_color(R, G, B, alp); }} // éé€éè‰²å€¤ã«å¤‰æ›´



    function rgb_hex(color){ // rgb or rgba è¡¨è¨˜ã‚’hex6æ¡è¡¨è¨˜ã«å¤‰æ›
        if(color.includes('#')){ // hexè¡¨è¨˜ã®å ´åˆ
            return color; }
        else{ // rgbè¡¨è¨˜ã®å ´åˆ
            color=color.split('(')[1].split(')')[0].replace(/ /g, '');
            let rgb_ar=color.split(',');

            let R=parseInt(rgb_ar[0], 10);
            let G=parseInt(rgb_ar[1], 10);
            let B=parseInt(rgb_ar[2], 10);
            let A;
            if(rgb_ar.length==3){
                A=1; }
            else if(rgb_ar.length==4){
                A=parseFloat(rgb_ar[3]); }

            return equal_color(R, G, B, A); }} // éé€éè‰²å€¤ã«å¤‰æ›´



    function before_end(){
        let submitButton=document.querySelectorAll('.js-submitButton');
        submitButton[0].addEventListener('mousedown', all_clear, false);
        submitButton[1].addEventListener('mousedown', all_clear, false);

        function all_clear(){
            let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            if(!editor_iframe){ //ã€ŒHTMLè¡¨ç¤ºã€ç·¨é›†ç”»é¢ã®å ´åˆ
                alert("â›”ã€€Blog Table ãŒå‡¦ç†ã‚’çµ‚äº†ã—ã¦ã„ã¾ã›ã‚“\n\n"+
                      "ã€€ã€€ é€šå¸¸è¡¨ç¤ºç”»é¢ã«æˆ»ã‚Š ç·¨é›†ã‚’çµ‚äº†ã—ã¦ãã ã•ã„");
                event.stopImmediatePropagation();
                event.preventDefault(); }
            if(editor_iframe){ //ã€Œé€šå¸¸è¡¨ç¤ºã€ç·¨é›†ç”»é¢ã®å ´åˆ
                remove_mark_all(); } // tableç·¨é›†ãƒ»TRIMãƒ»COLã®ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤
        }} // before_end(

} // main()
